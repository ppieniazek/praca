{% extends "base.html" %}
{% load i18n %}
{% block title %}
  {% trans "Finanse" %} - {{ wallet.user.get_full_name|default:wallet.user.username }} - Paver
{% endblock title %}
{% block content %}
  <div id="finance-dashboard" class="space-y-6">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <div class="flex items-center gap-4">
        {% if request.user.is_owner %}
          <a href="{% url 'business:finance_list' %}"
             class="btn btn-ghost btn-sm btn-circle">
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke-width="1.5"
                 stroke="currentColor"
                 class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
            </svg>
          </a>
        {% endif %}
        <div>
          <h1 class="text-2xl font-bold text-base-content">
            {% if request.user.is_owner %}
              {% trans "Finanse:" %} {{ wallet.user.get_full_name|default:wallet.user.username }}
            {% else %}
              {% trans "Moje Finanse" %}
            {% endif %}
          </h1>
          <p class="text-xs opacity-50 font-bold uppercase tracking-wider">{% trans "Historia transakcji" %}</p>
        </div>
      </div>
      <div class="flex gap-2">
        {% if request.user.is_owner %}
          <button class="btn btn-primary btn-sm shadow-sm"
                  data-on:click="@get('{% url 'business:refill_create' %}?wallet_id={{ wallet.id }}', {filterSignals: {include: '^__none__$'}})">
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke-width="1.5"
                 stroke="currentColor"
                 class="w-4 h-4 mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            {% trans "Zasil finanse" %}
          </button>
        {% else %}
          <button aria-label="Edytuj wydatek" class="btn btn-primary btn-sm shadow-sm"
                  data-on:click="@get('{% url 'business:expense_create' %}?wallet_id={{ wallet.id }}', {filterSignals: {include: '^__none__$'}})">
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke-width="1.5"
                 stroke="currentColor"
                 class="w-4 h-4 mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            {% trans "Dodaj wydatek" %}
          </button>
          <button aria-label="Wypłać zaliczkę" class="btn btn-outline btn-sm"
                  data-on:click="@get('{% url 'business:advance_create' %}?wallet_id={{ wallet.id }}', {filterSignals: {include: '^__none__$'}})">
            <svg xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke-width="1.5"
                 stroke="currentColor"
                 class="w-4 h-4 mr-1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
            </svg>
            {% trans "Wypłać zaliczkę" %}
          </button>
        {% endif %}
      </div>
    </div>
    <div id="finance-content">
      {% partialdef finance_content inline %}
      <div id="finance-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card bg-base-100 shadow-sm border border-base-300">
          <div class="card-body p-4">
            <div class="text-[10px] font-bold opacity-40 uppercase tracking-widest mb-1">{% trans "Saldo aktualne" %}</div>
            <div class="flex items-baseline gap-2">
              <span class="text-3xl font-bold {% if current_balance >= 0 %}text-success{% else %}text-error{% endif %}">
                {{ current_balance|floatformat:2 }}
              </span>
              <span class="text-sm font-bold opacity-30">PLN</span>
            </div>
          </div>
        </div>
        <div class="card bg-base-100 shadow-sm border border-base-300">
          <div class="card-body p-4">
            <div class="text-[10px] font-bold opacity-40 uppercase tracking-widest mb-1">{% trans "Wydatki (ten miesiąc)" %}</div>
            <div class="flex items-baseline gap-2">
              <span class="text-3xl font-bold text-base-content/80">{{ monthly_expenses_sum|default:0|floatformat:2 }}</span>
              <span class="text-sm font-bold opacity-30">PLN</span>
            </div>
          </div>
        </div>
        <div class="card bg-base-100 shadow-sm border border-base-300">
          <div class="card-body p-4">
            <div class="text-[10px] font-bold opacity-40 uppercase tracking-widest mb-1">{% trans "Wypłacone zaliczki" %}</div>
            <div class="flex items-baseline gap-2">
              <span class="text-3xl font-bold text-base-content/80">{{ total_advances_sum|default:0|floatformat:2 }}</span>
              <span class="text-sm font-bold opacity-30">PLN</span>
            </div>
          </div>
        </div>
      </div>
      <div class="card bg-base-100 shadow-sm border border-base-300 mt-6">
        <div class="overflow-x-auto">
          <table class="table table-zebra w-full">
            <thead>
              <tr class="bg-base-200/50">
                <th class="text-[10px] uppercase opacity-50">{% trans "Data" %}</th>
                <th class="text-[10px] uppercase opacity-50">{% trans "Typ / Kategoria" %}</th>
                <th class="text-[10px] uppercase opacity-50">{% trans "Opis / Pracownik" %}</th>
                <th class="text-[10px] uppercase opacity-50 text-center">{% trans "Dowód" %}</th>
                <th class="text-[10px] uppercase opacity-50 text-right">{% trans "Kwota" %}</th>
                <th class="text-[10px] uppercase opacity-50 text-right">{% trans "Akcje" %}</th>
              </tr>
            </thead>
            <tbody id="transaction-list">
              {% partialdef transaction_list inline %}
              {% for t in transactions %}
                <tr class="hover:bg-base-200/30 transition-colors">
                  <td class="whitespace-nowrap">
                    <div class="text-xs font-bold opacity-70">{{ t.date|date:"d.m.Y" }}</div>
                  </td>
                  <td>
                    <div class="flex items-center gap-2">
                      {% if t.type == 'REFILL' %}
                        <div class="p-1.5 bg-success/10 text-success rounded-lg">
                          <svg xmlns="http://www.w3.org/2000/svg"
                               fill="none"
                               viewBox="0 0 24 24"
                               stroke-width="2"
                               stroke="currentColor"
                               class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                          </svg>
                        </div>
                        <div>
                          <div class="text-xs font-bold">{% trans "Zasilenie" %}</div>
                        </div>
                      {% elif t.type == 'EXPENSE' %}
                        <div class="p-1.5 bg-error/10 text-error rounded-lg">
                          <svg xmlns="http://www.w3.org/2000/svg"
                               fill="none"
                               viewBox="0 0 24 24"
                               stroke-width="2"
                               stroke="currentColor"
                               class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" />
                          </svg>
                        </div>
                        <div>
                          <div class="flex items-center gap-1">
                            <div class="text-xs font-bold">{% trans "Wydatek" %}</div>
                            {% if t.receipt_image %}
                              <svg xmlns="http://www.w3.org/2000/svg"
                                   fill="none"
                                   viewBox="0 0 24 24"
                                   stroke-width="2"
                                   stroke="currentColor"
                                   class="w-3 h-3 text-primary animate-pulse"
                                   title="{% trans 'Zawiera dowód' %}">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32a1.5 1.5 0 1 1-2.121-2.121l10.94-10.94" />
                              </svg>
                            {% endif %}
                          </div>
                          <div class="text-[10px] opacity-50 uppercase font-bold">{{ t.get_category_display }}</div>
                        </div>
                      {% elif t.type == 'ADVANCE' %}
                        <div class="p-1.5 bg-warning/10 text-warning rounded-lg">
                          <svg xmlns="http://www.w3.org/2000/svg"
                               fill="none"
                               viewBox="0 0 24 24"
                               stroke-width="2"
                               stroke="currentColor"
                               class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                          </svg>
                        </div>
                        <div>
                          <div class="text-xs font-bold">{% trans "Zaliczka" %}</div>
                        </div>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <div class="text-xs text-base-content/70 max-w-xs truncate">
                      {% if t.type == 'ADVANCE' %}
                        <span class="font-bold text-primary">{{ t.worker }}</span>
                        {% if t.description %}<span class="opacity-50 ml-1">- {{ t.description }}</span>{% endif %}
                      {% else %}
                        {{ t.description|default:"---" }}
                      {% endif %}
                    </div>
                  </td>
                  <td class="text-center">
                    {% if t.receipt_image %}
                      <button data-on:click="@get('{% url 'business:transaction_receipt_modal' t.pk %}', {filterSignals: {include: '^__none__$'}})"
                              class="group relative inline-block">
                        <div class="avatar">
                          <div class="w-10 h-10 rounded-lg ring-1 ring-base-300 group-hover:ring-primary transition-all overflow-hidden bg-base-200">
                            <img src="{% url 'business:transaction_receipt' t.pk %}"
                                 alt="{% trans 'Dowód' %}"
                                 width="40"
                                 height="40"
                                 loading="lazy"
                                 class="object-cover w-full h-full" />
                          </div>
                        </div>
                        <div class="absolute -top-1 -right-1 bg-primary text-white p-0.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-sm">
                          <svg xmlns="http://www.w3.org/2000/svg"
                               fill="none"
                               viewBox="0 0 24 24"
                               stroke-width="2.5"
                               stroke="currentColor"
                               class="w-2.5 h-2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                          </svg>
                        </div>
                      </button>
                    {% else %}
                      <span class="text-[10px] opacity-20 uppercase font-bold">{% trans "Brak" %}</span>
                    {% endif %}
                  </td>
                  <td class="text-right">
                    <div class="text-sm font-bold {% if t.type == 'REFILL' %}text-success{% elif t.type == 'EXPENSE' %}text-error{% else %}text-warning{% endif %}">
                      {% if t.type == 'REFILL' %}
                        +
                      {% else %}
                        -
                      {% endif %}
                      {{ t.amount|floatformat:2 }}
                      <span class="text-[10px] opacity-40 ml-0.5">PLN</span>
                    </div>
                  </td>
                  <td class="text-right">
                    <div class="flex justify-end gap-1">
                      <button aria-label="Edytuj" class="btn btn-ghost btn-xs opacity-40 hover:opacity-100"
                              title="{% trans 'Edytuj' %}"
                              data-on:click="@get('{% url 'business:transaction_edit' t.pk %}', {filterSignals: {include: '^__none__$'}})">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke-width="1.5"
                             stroke="currentColor"
                             class="w-3.5 h-3.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H4.5A2.25 2.25 0 0 1 2.25 18.75V6.75A2.25 2.25 0 0 1 4.5 4.5H9" />
                        </svg>
                      </button>
                      <button aria-label="Usuń" class="btn btn-ghost btn-xs text-error opacity-40 hover:opacity-100"
                              title="{% trans 'Usuń' %}"
                              data-on:click="if(confirm('{% trans "Czy na pewno chcesz usunąć tę transakcję?" %}')) @post('{% url 'business:transaction_delete' t.pk %}', {headers: getCsrfParams().headers, filterSignals: {include: '^__none__$'}})">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke-width="1.5"
                             stroke="currentColor"
                             class="w-3.5 h-3.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="6" class="py-12 text-center opacity-40 italic text-sm">{% trans "Brak transakcji w historii." %}</td>
                </tr>
              {% endfor %}
            {% endpartialdef %}
          </tbody>
        </table>
      </div>
    </div>
  {% endpartialdef %}
</div>
</div>
{% partialdef expense_form %}
<div id="modal-content"
     class="modal-box max-w-lg bg-base-100 p-0 overflow-hidden border border-base-300 shadow-2xl">
  <div class="p-6">
    <div class="flex justify-between items-start mb-6">
      <h3 class="font-bold text-xl text-base-content">{{ title }}</h3>
      <button type="button"
              class="btn btn-ghost btn-sm btn-circle"
              data-on:click="$is_modal_open = false">✕</button>
    </div>
    <form data-on:submit__prevent="@post('{{ url }}', {contentType: 'form'})"
          enctype="multipart/form-data">
      {% csrf_token %}
      {% include "partials.html#non_field_errors" %}
      <div class="space-y-4">
        {% include "partials.html#form_field" with field=form.amount %}
        {% include "partials.html#form_field" with field=form.category %}
        {% include "partials.html#form_field" with field=form.date %}
        {% include "partials.html#form_field" with field=form.project %}
        {% include "partials.html#form_field" with field=form.description %}
        {% include "partials.html#form_field" with field=form.receipt_image %}
      </div>
      <div class="modal-action mt-8 border-t border-base-200 pt-4">
        <button type="button"
                class="btn btn-ghost btn-sm"
                data-on:click="$is_modal_open = false">{% trans "Anuluj" %}</button>
        <button type="submit" class="btn btn-primary btn-sm px-8 shadow-lg">{% trans "Zapisz" %}</button>
      </div>
    </form>
  </div>
</div>
{% endpartialdef %}
{% partialdef advance_form %}
<div id="modal-content"
     class="modal-box max-w-lg bg-base-100 p-0 overflow-hidden border border-base-300 shadow-2xl">
  <div class="p-6">
    <div class="flex justify-between items-start mb-6">
      <h3 class="font-bold text-xl text-base-content">{{ title }}</h3>
      <button type="button"
              class="btn btn-ghost btn-sm btn-circle"
              data-on:click="$is_modal_open = false">✕</button>
    </div>
    <form data-on:submit__prevent="@post('{{ url }}', {contentType: 'form'})">
      {% csrf_token %}
      {% include "partials.html#non_field_errors" %}
      <div class="space-y-4">
        {% include "partials.html#form_field" with field=form.worker %}
        {% include "partials.html#form_field" with field=form.amount %}
        {% include "partials.html#form_field" with field=form.date %}
        {% include "partials.html#form_field" with field=form.description %}
      </div>
      <div class="modal-action mt-8 border-t border-base-200 pt-4">
        <button type="button"
                class="btn btn-ghost btn-sm"
                data-on:click="$is_modal_open = false">{% trans "Anuluj" %}</button>
        <button type="submit" class="btn btn-primary btn-sm px-8 shadow-lg">{% trans "Zapisz" %}</button>
      </div>
    </form>
  </div>
</div>
{% endpartialdef %}
{% partialdef receipt_preview %}
<div id="modal-content"
     class="modal-box max-w-2xl bg-base-100 p-0 overflow-hidden border border-base-300 shadow-2xl">
  <div class="p-6">
    <div class="flex justify-between items-start mb-4">
      <div>
        <h3 class="font-bold text-xl text-base-content">{% trans "Podgląd dowodu" %}</h3>
        <p class="text-xs opacity-50">
          {{ transaction.get_type_display }} - {{ transaction.amount }} PLN ({{ transaction.date|date:"d.m.Y" }})
        </p>
      </div>
      <button type="button"
              class="btn btn-ghost btn-sm btn-circle"
              data-on:click="$is_modal_open = false">✕</button>
    </div>
    <div class="bg-base-200 rounded-xl overflow-hidden flex justify-center">
      <img src="{% url 'business:transaction_receipt' transaction.pk %}"
           alt="{% trans 'Dowód' %}"
           width="800"
           height="600"
           loading="lazy"
           class="max-w-full h-auto shadow-inner" />
    </div>
    <div class="modal-action mt-6 border-t border-base-200 pt-4">
      <a href="{% url 'business:transaction_receipt' transaction.pk %}"
         download
         class="btn btn-ghost btn-sm gap-2">
        <svg xmlns="http://www.w3.org/2000/svg"
             fill="none"
             viewBox="0 0 24 24"
             stroke-width="1.5"
             stroke="currentColor"
             class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M7.5 12 12 16.5m0 0 4.5-4.5M12 16.5V3" />
        </svg>
        {% trans "Pobierz" %}
      </a>
      <button type="button"
              class="btn btn-primary btn-sm px-8"
              data-on:click="$is_modal_open = false">{% trans "Zamknij" %}</button>
    </div>
  </div>
</div>
{% endpartialdef %}
{% endblock content %}
